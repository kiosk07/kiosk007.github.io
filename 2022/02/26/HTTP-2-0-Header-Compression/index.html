<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="HTTP/2.0 Header Compression"><meta name="keywords" content="network"><meta name="author" content="kiosk"><meta name="copyright" content="kiosk"><title>HTTP/2.0 Header Compression | kiosk007's Blog</title><link rel="shortcut icon" href="/img/favicon-16x16-dragon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?6f3d277b6c83066a05a8b7db067b2308";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.3.0'
} </script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="kiosk007's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E9%97%A8%E8%A7%81%E5%B1%B1"><span class="toc-number">1.</span> <span class="toc-text">开门见山</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">压缩原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Indexs-Table"><span class="toc-number">2.1.</span> <span class="toc-text">Indexs Table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Static-Table"><span class="toc-number">2.2.</span> <span class="toc-text">Static Table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dynamic-Table"><span class="toc-number">2.3.</span> <span class="toc-text">Dynamic Table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HPACK-Encoding"><span class="toc-number">2.4.</span> <span class="toc-text">HPACK Encoding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95-Header-%E8%A1%A8%E7%A4%BA%E6%B3%95"><span class="toc-number">2.5.</span> <span class="toc-text">索引 Header 表示法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-%E5%92%8C-Value-%E5%9D%87%E8%A2%AB%E7%B4%A2%E5%BC%95%E8%BF%87"><span class="toc-number">2.5.1.</span> <span class="toc-text">Key 和 Value 均被索引过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%8A%A8%E6%80%81%E8%A1%A8"><span class="toc-number">2.5.2.</span> <span class="toc-text">增加动态表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Huffman-%E7%BC%96%E7%A0%81%E5%8E%9F%E7%90%86"><span class="toc-number">2.5.3.</span> <span class="toc-text">Huffman 编码原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-amp-%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">验证&amp;总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HPACK-%E7%BC%96%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">HPACK 编码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HPACK-%E8%A7%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">HPACK 解码</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://img1.kiosk007.top/static/images/avatar.jpg"></div><div class="author-info__name text-center">kiosk</div><div class="author-info__description text-center">NoOps</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/weijiaxiang007">Ordinary But Great</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">47</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">20</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">11</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://img1.kiosk007.top/static/images/backgroud_sbpk.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">kiosk007's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/about/">关于</a><a class="site-page" href="/archives/">文章</a><a class="site-page" href="/tags/">标签</a><a class="site-page" href="/categories/">分类</a><a class="site-page" href="/express/">Express</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">HTTP/2.0 Header Compression</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-02-26</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/network/">network</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.8k</span><span class="post-meta__separator">|</span><span>Reading time: 17 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>在 <span style="color:#FF7F50">HTTP/1.x </span>时代，支持Body压缩，Header不支持压缩。而现在一个网页可能有几十到上百个请求，一个请求Header至少 500Byte 以上。而这些页面的请求Header大多都是一些重复的字符如UA、Cookie，会消耗不必要的带宽，增加延迟。</p>
<p>在<span style="color:#FF7F50">HTTP/2.0</span>中，引入了<span style="color:#FF7F5">Header Compression</span>（<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7541" style="color:#556B2F">rfc7541</a>），头部压缩技术使用了HPACK，有效的压缩了Header。</p>
<a id="more"></a>
<h1 id="开门见山"><a href="#开门见山" class="headerlink" title="开门见山"></a>开门见山</h1><p>我们先看看压缩效果，我们先来看一下<span style="color:#FF7F50">HPACK</span>压缩效果。比如说一个简单的HTTP请求，Header大约是 900 Byte，在<span style="color:#FF7F50"> HTTP/2.0 </span>中，首次请求会被压缩到 600 Byte，接着在后续的请求中会被压缩到 120 Byte，首次请求压缩率达到 <span style="color:#FF7F50"> 50% </span>，后续达到 <span style="color:#FF7F50"> 95% </span>。可以说效果是非常明显的，如下图（<span style="color:#FF7F50"> wireshark </span> 抓包 ）：</p>
<p>实验：我们使用 curl 命令发起请求观察。先发起一个 <span style="color:#FF7F50"> http1.1 </span> 请求，再连续发起2个 <span style="color:#FF7F50"> HTTP2 </span> 请求对比。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SSLKEYLOGFILE=~/sslkey.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用http1.1 请求</span></span><br><span class="line">curl --http1.1 -v <span class="string">&#x27;https://kiosk.io/admin/&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;authority: kiosk.io&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;pragma: no-cache&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;cache-control: no-cache&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua: &quot; Not;A Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;97&quot;, &quot;Chromium&quot;;v=&quot;97&quot;&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua-mobile: ?0&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua-platform: &quot;Linux&quot;&#x27;</span> \</span><br><span class="line">  ....  多加一些 Header 可以体现出压缩效率</span><br><span class="line">  -H <span class="string">&#x27;cookie: 1234567890qwertyuiopasdfghjklzxcvbnm&#x27;</span> -o /dev/null \</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 使用http2 请求</span></span><br><span class="line">curl --http2 -v <span class="string">&#x27;https://kiosk.io/admin/&#x27;</span> \</span><br><span class="line">  ....  Header 保持和H1一样，这里省略</span><br><span class="line">  --next --http2 -v <span class="string">&#x27;https://kiosk.io/admin/&#x27;</span> \</span><br><span class="line">  ....  Header 省略</span><br></pre></td></tr></table></figure>
<p><img src="https://img1.kiosk007.top/static/images/network/HTTP2/http2_header_compression2.png"></p>
<h1 id="压缩原理"><a href="#压缩原理" class="headerlink" title="压缩原理"></a>压缩原理</h1><p><span style="color:#FF7F50"> HTTP2</span> 使用 <span style="color:#FF7F50"> HPACK </span> 压缩格式压缩请求和响应标头元数据，这种格式采用下面两种技术压缩：</p>
<ul>
<li>通过静态哈夫曼代码对传输的标头字段进行编码，从而减小数据传输的大小。</li>
<li>单个连接中，client 和 server 共同维护一个相同的标头字段索引列表，此列表在之后的传输中用作编解码的参考。</li>
</ul>
<p><img src="https://img1.kiosk007.top/static/images/network/HTTP2/http2_header_compression3.png"></p>
<p>下面参考Golang <a target="_blank" rel="noopener" href="https://github.com/golang/net/tree/master/http2/hpack" style="color:#556B2F">http2/hpack</a> 的实现，详细介绍一下其工作模式。</p>
<h2 id="Indexs-Table"><a href="#Indexs-Table" class="headerlink" title="Indexs Table"></a>Indexs Table</h2><p>索引表（rfc7541#section-2.3），包含<span style="color:#FF7F50">Static Table</span>静态表、<span style="color:#FF7F50">Dynamic Table</span>动态表。静态表包含61个预定义的<span style="color:#FF7F50">key value</span>，动态表包含自定义的<span style="color:#FF7F50">key value</span>。</p>
<p><span style="color:#FF7F50">HPACK</span>使用<span style="color:#FF7F50">Static Table</span>、<span style="color:#FF7F50">Dynamic Table</span>将<span style="color:#FF7F50">Header</span>字段与索引<span style="color:#FF7F50">Index</span>相关联，这两个表合并为一个地址空间，用于定义索引值，如下图：</p>
<p><img src="https://img1.kiosk007.top/static/images/network/HTTP2/http2_header_compression4.png"></p>
<p>认识静/动态索引表需要先认识<span style="color:#FF7F50">headerFieldTable</span>结构体，动态表和静态表都是基于它实现的。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> headerFieldTable <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// As in hpack, unique ids  are 1-based. The unique id for ents[k] is k + evictCount + 1.</span></span><br><span class="line">	ents       []HeaderField</span><br><span class="line">	evictCount <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// byName maps a HeaderField name to the unique id of the newest entry with the same name.</span></span><br><span class="line">	byName <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// byNameValue maps a HeaderField name/value pair to the unique id of the newest</span></span><br><span class="line">	byNameValue <span class="keyword">map</span>[pairNameValue]<span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面将对上述的字段分别进行描述：</p>
<ul>
<li><strong>ents</strong>：entries 的缩写，代表着当前已经索引的 Header 数据。在 headerFieldTable 中，每一个 Header 都有一个唯一的 Id，以ents[k]为例，该唯一 id 的计算方式是k + evictCount + 1。</li>
<li><strong>evictCount</strong>：已经从 ents 中删除的条目数。</li>
<li><strong>byName</strong>：存储具有相同 Name 的 Header 的唯一 Id，最新 Header 的 Name 会覆盖老的唯一 Id。</li>
<li><strong>byNameValue</strong>：以 Header 的 Name 和 Value 为 key 存储对应的唯一 Id。</li>
</ul>
<p>对字段的含义有所了解后，接下来对 <span style="color:#FF7F50">headerFieldTable </span> 几个比较重要的方法进行解析。</p>
<ul>
<li><strong>(t *headerFieldTable) addEntry(f HeaderField)</strong>: 将Header加入到 <span style="color:#FF7F50">headerFieldTable </span> 中</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *headerFieldTable)</span> <span class="title">addEntry</span><span class="params">(f HeaderField)</span></span> &#123;</span><br><span class="line">	id := <span class="keyword">uint64</span>(t.<span class="built_in">len</span>()) + t.evictCount + <span class="number">1</span></span><br><span class="line">	t.byName[f.Name] = id</span><br><span class="line">	t.byNameValue[pairNameValue&#123;f.Name, f.Value&#125;] = id</span><br><span class="line">	t.ents = <span class="built_in">append</span>(t.ents, f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>计算出 <span style="color:#FF7F50">Header</span> 在 <span style="color:#FF7F50">headerFieldTable</span> 中的唯一 <span style="color:#FF7F50">Id</span>，并将其分别存入<span style="color:#FF7F50">byName</span>和<span style="color:#FF7F50">byNameValue</span>中。最后，将 <span style="color:#FF7F50">Header</span> 存入<span style="color:#FF7F50">ents</span>。</p>
<ul>
<li><strong>(t *headerFieldTable) evictOldest</strong>: 将Header从 <span style="color:#FF7F50">headerFieldTable </span> 中删除，毕竟索引表是有大小限制的。</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *headerFieldTable)</span> <span class="title">evictOldest</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> n &gt; t.<span class="built_in">len</span>() &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;evictOldest(%v) on table with %v entries&quot;</span>, n, t.<span class="built_in">len</span>()))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> k := <span class="number">0</span>; k &lt; n; k++ &#123;</span><br><span class="line">		f := t.ents[k]</span><br><span class="line">		id := t.evictCount + <span class="keyword">uint64</span>(k) + <span class="number">1</span></span><br><span class="line">		<span class="keyword">if</span> t.byName[f.Name] == id &#123;</span><br><span class="line">			<span class="built_in">delete</span>(t.byName, f.Name)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> p := (pairNameValue&#123;f.Name, f.Value&#125;); t.byNameValue[p] == id &#123;</span><br><span class="line">			<span class="built_in">delete</span>(t.byNameValue, p)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">copy</span>(t.ents, t.ents[n:])</span><br><span class="line">	<span class="keyword">for</span> k := t.<span class="built_in">len</span>() - n; k &lt; t.<span class="built_in">len</span>(); k++ &#123;</span><br><span class="line">		t.ents[k] = HeaderField&#123;&#125; <span class="comment">// so strings can be garbage collected</span></span><br><span class="line">	&#125;</span><br><span class="line">	t.ents = t.ents[:t.<span class="built_in">len</span>()-n]</span><br><span class="line">	<span class="keyword">if</span> t.evictCount+<span class="keyword">uint64</span>(n) &lt; t.evictCount &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;evictCount overflow&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	t.evictCount += <span class="keyword">uint64</span>(n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一个 for 循环的下标是从 0 开始的，也就是说删除 <span style="color:#FF7F50">Header</span> 时遵循先进先出的原则。删除 <span style="color:#FF7F50">Header</span> 的步骤如下：</p>
<ol>
<li>删除<span style="color:#FF7F50">byName</span>和<span style="color:#FF7F50">byNameValue</span>的映射。</li>
<li>将第 n 位及其之后的 <span style="color:#FF7F50">Header</span> 前移。</li>
<li>将倒数的 n 个 <span style="color:#FF7F50">Header</span> 置空，以方便垃圾回收。</li>
<li>改变 ents 的长度。</li>
<li>增加<span style="color:#FF7F50">evictCount</span>的数量。</li>
</ol>
<ul>
<li><strong>(t *headerFieldTable) search(f HeaderField)</strong> 从当前表中搜索指定 Header 并返回在当前表中的 Index（此处的Index和切片中的下标含义是不一样的）</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *headerFieldTable)</span> <span class="title">search</span><span class="params">(f HeaderField)</span> <span class="params">(i <span class="keyword">uint64</span>, nameValueMatch <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !f.Sensitive &#123;</span><br><span class="line">		<span class="keyword">if</span> id := t.byNameValue[pairNameValue&#123;f.Name, f.Value&#125;]; id != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> t.idToIndex(id), <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> id := t.byName[f.Name]; id != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> t.idToIndex(id), <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>如果 <span style="color:#FF7F50">Header</span> 的 <span style="color:#FF7F50">Name</span>和 <span style="color:#FF7F50">Value </span>均匹配，则返回当前表中的 <span style="color:#FF7F50">Index</span> 且<span style="color:#FF7F50">nameValueMatch</span> 为 true。</li>
<li>如果仅有 <span style="color:#FF7F50">Header</span> 的 <span style="color:#FF7F50">Name</span> 匹配，则返回当前表中的 <span style="color:#FF7F50">Index</span> 且<span style="color:#FF7F50">nameValueMatch</span>为 false。</li>
<li>如果 <span style="color:#FF7F50">Header</span> 的 <span style="color:#FF7F50">Name</span> 和 <span style="color:#FF7F50">Value</span> 均不匹配，则返回 0 且 <span style="color:#FF7F50">nameValueMatch</span>为 false。</li>
</ol>
<ul>
<li><strong>(t *headerFieldTable) idToIndex(id uint64)</strong> 通过当前表中的唯一 Id 计算出当前表对应的 Index</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *headerFieldTable)</span> <span class="title">idToIndex</span><span class="params">(id <span class="keyword">uint64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> id &lt;= t.evictCount &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;id (%v) &lt;= evictCount (%v)&quot;</span>, id, t.evictCount))</span><br><span class="line">	&#125;</span><br><span class="line">	k := id - t.evictCount - <span class="number">1</span> <span class="comment">// convert id to an index t.ents[k]</span></span><br><span class="line">	<span class="keyword">if</span> t != staticTable &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">uint64</span>(t.<span class="built_in">len</span>()) - k <span class="comment">// dynamic table</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> k + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>静态表：<span style="color:#FF7F50">Index</span>从 1 开始，且 Index 为 1 时对应的元素为t.ents[0]。</li>
<li>动态表: <span style="color:#FF7F50">Index</span>也从 1 开始，但是 Index 为 1 时对应的元素为t.ents[t.len()-1]。</li>
</ol>
<h2 id="Static-Table"><a href="#Static-Table" class="headerlink" title="Static Table"></a>Static Table</h2><p>静态表（<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7541#section-2.3.1" style="color:#556B2F">rfc7541#section-2.3.1</a>），包含61个预定义Header key-value，传输的时候使用对应的索引Index替换。静态表内容具体的定义可以参考这里 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7541#appendix-A" style="color:#556B2F">rfc7541#appendix-A</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+-------+-----------------------------+---------------+</span><br><span class="line">| Index | Header Name                 | Header Value  |</span><br><span class="line">+-------+-----------------------------+---------------+</span><br><span class="line">| 1     | :authority                  |               |</span><br><span class="line">| 2     | :method                     | GET           |</span><br><span class="line">| 3     | :method                     | POST          |</span><br><span class="line">| 4     | :path                       | &#x2F;             |</span><br><span class="line">| 5     | :path                       | &#x2F;index.html   |</span><br><span class="line">| 6     | :scheme                     | http          |</span><br><span class="line">| 7     | :scheme                     | https         |</span><br><span class="line">| 8     | :status                     | 200           |</span><br><span class="line">| 9     | :status                     | 204           |</span><br><span class="line">| 10    | :status                     | 206           |</span><br><span class="line">| 11    | :status                     | 304           |</span><br><span class="line">| 12    | :status                     | 400           |</span><br><span class="line">| 13    | :status                     | 404           |</span><br><span class="line">| 14    | :status                     | 500           |</span><br><span class="line">| 15    | accept-charset              |               |</span><br><span class="line">...省略</span><br><span class="line">| 58    | user-agent                  |               |</span><br><span class="line">| 59    | vary                        |               |</span><br><span class="line">| 60    | via                         |               |</span><br><span class="line">| 61    | www-authenticate            |               |</span><br><span class="line">+-------+-----------------------------+---------------+</span><br></pre></td></tr></table></figure>
<p>在golang里的实现如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> staticTable = newStaticTable()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newStaticTable</span><span class="params">()</span> *<span class="title">headerFieldTable</span></span> &#123;</span><br><span class="line">	t := &amp;headerFieldTable&#123;&#125;</span><br><span class="line">	t.init()</span><br><span class="line">	<span class="keyword">for</span> _, e := <span class="keyword">range</span> staticTableEntries[:] &#123;</span><br><span class="line">		t.addEntry(e)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> staticTableEntries = [...]HeaderField&#123;</span><br><span class="line">	&#123;Name: <span class="string">&quot;:authority&quot;</span>&#125;,</span><br><span class="line">	&#123;Name: <span class="string">&quot;:method&quot;</span>, Value: <span class="string">&quot;GET&quot;</span>&#125;,</span><br><span class="line">	&#123;Name: <span class="string">&quot;:method&quot;</span>, Value: <span class="string">&quot;POST&quot;</span>&#125;,</span><br><span class="line">  <span class="comment">// 此处省略代码</span></span><br><span class="line">	&#123;Name: <span class="string">&quot;www-authenticate&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的<span style="color:#FF7F50">t.init</span>函数仅做初始化<span style="color:#FF7F50">t.byName</span>和<span style="color:#FF7F50">t.byNameValue</span>用。</p>
<p>实际传输的过程中如果遇到对应的字符，则直接以index代替。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:method GET &#x3D; 2 &#x3D; 00000010</span><br><span class="line">:method POST &#x3D; 3 &#x3D; 00000011</span><br><span class="line">:path &#x2F; &#x3D; 4 &#x3D; 00000100</span><br><span class="line">:path &#x2F;index.html &#x3D; 5 &#x3D; 00000101</span><br><span class="line">:scheme https &#x3D; 7 &#x3D; 00000111</span><br></pre></td></tr></table></figure>
<h2 id="Dynamic-Table"><a href="#Dynamic-Table" class="headerlink" title="Dynamic Table"></a>Dynamic Table</h2><p>动态表（<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7541#section-2.3.2" style="color:#556B2F"> rfc7541#section-2.3.2</a>），是一个<span style="color:#FF7F50">FIFO</span>队列，初始是空的，它有以下特点：</p>
<p>解压header的时候按需添加，每次添加的时候，放在队首，移除的时候，从队尾开始。</p>
<p>大小不是无限制的，可以通过<span style="color:#FF7F50">SETTING Frame</span>里的<span style="color:#FF7F50"><strong>SETTINGS_HEADER_TABLE_SIZE</strong></span>设置，默认 256Byte。</p>
<p>动/静态表中内部的 <span style="color:#FF7F50">Index</span> 和内部的唯一 <span style="color:#FF7F50">Id</span>，而在一次连接中 <span style="color:#FF7F50">HPACK </span> 索引列表是由静态表和动态表一起构成</p>
<p><img src="https://img1.kiosk007.top/static/images/network/HTTP2/http2_header_compression5.png"></p>
<p>上图蓝色区域是静态表，黄色区域是动态表。</p>
<p><strong>在 HPACK 索引中静态表部分的索引和静态表的内部索引保持一致，动态表部分的索引为动态表内部索引加上静态表索引的最大值。</strong> 在一次连接中 <span style="color:#FF7F50">Client</span> 和 <span style="color:#FF7F50">Server</span> 通过 <span style="color:#FF7F50">HPACK </span>索引标识唯一的 <span style="color:#FF7F50">Header</span> 元素。</p>
<h2 id="HPACK-Encoding"><a href="#HPACK-Encoding" class="headerlink" title="HPACK Encoding"></a>HPACK Encoding</h2><p>在 golang 的 <code>func (e *Encoder) WriteField(f HeaderField) error</code> 方法中可以看到什么时候用的静态表，什么时候用的动态表。先看看这个方法。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WriteField encodes f into a single Write to e&#x27;s underlying Writer.</span></span><br><span class="line"><span class="comment">// This function may also produce bytes for &quot;Header Table Size Update&quot;</span></span><br><span class="line"><span class="comment">// if necessary. If produced, it is done before encoding f.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Encoder)</span> <span class="title">WriteField</span><span class="params">(f HeaderField)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	e.buf = e.buf[:<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收到 SETTINGS 帧，且包含 SettingHeaderTableSize 表示动态表需要更新，才会进入到这里	</span></span><br><span class="line">	<span class="keyword">if</span> e.tableSizeUpdate &#123;	     </span><br><span class="line">        e.tableSizeUpdate = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">if</span> e.minSize &lt; e.dynTab.maxSize &#123;</span><br><span class="line">			e.buf = appendTableSize(e.buf, e.minSize)</span><br><span class="line">		&#125;</span><br><span class="line">		e.minSize = uint32Max</span><br><span class="line">		e.buf = appendTableSize(e.buf, e.dynTab.maxSize)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找是否被索引	</span></span><br><span class="line">    idx, nameValueMatch := e.searchTable(f)</span><br><span class="line">	<span class="keyword">if</span> nameValueMatch &#123;</span><br><span class="line">		e.buf = appendIndexed(e.buf, idx)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 是否应该被索引，有可能设置一些敏感词不应该被索引，golang indexing 一直是true		</span></span><br><span class="line">        indexing := e.shouldIndex(f)</span><br><span class="line">		<span class="keyword">if</span> indexing &#123;</span><br><span class="line">			e.dynTab.add(f)     <span class="comment">// 加入动态表		</span></span><br><span class="line">   	 	&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> idx == <span class="number">0</span> &#123;</span><br><span class="line">			e.buf = appendNewName(e.buf, f, indexing)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			e.buf = appendIndexedName(e.buf, f, idx, indexing)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	n, err := e.w.Write(e.buf)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; n != <span class="built_in">len</span>(e.buf) &#123;</span><br><span class="line">		err = io.ErrShortWrite</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面我们对上面的一些函数做一些分析。</p>
<ul>
<li><strong>(e *Encoder) searchTable(f HeaderField)</strong> 从 HPACK 索引列表中搜索 Header，并返回对应的索引。</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Encoder)</span> <span class="title">searchTable</span><span class="params">(f HeaderField)</span> <span class="params">(i <span class="keyword">uint64</span>, nameValueMatch <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	i, nameValueMatch = staticTable.search(f)</span><br><span class="line">	<span class="keyword">if</span> nameValueMatch &#123;</span><br><span class="line">		<span class="keyword">return</span> i, <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	j, nameValueMatch := e.dynTab.table.search(f)</span><br><span class="line">	<span class="keyword">if</span> nameValueMatch || (i == <span class="number">0</span> &amp;&amp; j != <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> j + <span class="keyword">uint64</span>(staticTable.<span class="built_in">len</span>()), nameValueMatch</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> i, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>搜索顺序为，先搜索静态表，如果静态表不匹配，则搜索动态表，最后返回。</p>
<h2 id="索引-Header-表示法"><a href="#索引-Header-表示法" class="headerlink" title="索引 Header 表示法"></a>索引 Header 表示法</h2><h3 id="Key-和-Value-均被索引过"><a href="#Key-和-Value-均被索引过" class="headerlink" title="Key 和 Value 均被索引过"></a>Key 和 Value 均被索引过</h3><p>如果<span style="color:#FF7F50">Name</span>和<span style="color:#FF7F50">Value</span> 都已经被索引，则在Header的编码过程中直接添加索引即可<br>此表示法对应的函数为 <span style="color:#FF7F50">appendIndexed</span>，且该 <span style="color:#FF7F50">Header</span> 已经在索引列表中。<br>该函数将 <span style="color:#FF7F50">Header</span> 在 <span style="color:#FF7F50">HPACK</span> 索引列表中的索引编码，原先的 <span style="color:#FF7F50">Header</span> 最后仅用少量的几个字节就可以表示。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendIndexed</span><span class="params">(dst []<span class="keyword">byte</span>, i <span class="keyword">uint64</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	first := <span class="built_in">len</span>(dst)</span><br><span class="line">	dst = appendVarInt(dst, <span class="number">7</span>, i)</span><br><span class="line">	dst[first] |= <span class="number">0x80</span></span><br><span class="line">	<span class="keyword">return</span> dst</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由<span style="color:#FF7F50">appendIndexed</span>知，用索引头字段表示法时，第一个字节的格式必须是 <strong>0b1xxxxxxx</strong>，即第 0 位必须为1，低 7 位用来表示值。<br>如果索引大于 <strong>uint64((1 &lt;&lt; n) - 1)</strong>时，需要使用多个字节来存储索引的值，步骤如下：</p>
<ol>
<li>第一个字节的最低 n 位全为 1。</li>
<li>索引 i 减去 <strong>uint64((1 &lt;&lt; n) - 1)</strong>后，每次取低 7 位或上<strong>0b10000000</strong>， 然后 i 右移 7 位并和 128 进行比较，判断是否进入下一次循环。</li>
<li>循环结束后将剩下的 i 值直接放入 buf 中。</li>
</ol>
<p>用这种方法表示 <span style="color:#FF7F50"> Header </span>时，仅需要少量字节就可以表示一个完整的 <span style="color:#FF7F50">Header</span> 头字段，最好的情况是一个字节就可以表示一个 <span style="color:#FF7F50">Header</span> 字段。</p>
<blockquote>
<p>VarInt 是一种编码方式, 可以参考 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/84250836">https://zhuanlan.zhihu.com/p/84250836</a></p>
</blockquote>
<p>可参考 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7541#section-6.1" style="color:#556B2F"> rfc7541#section-6.1</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  0   1   2   3   4   5   6   7</span><br><span class="line">+---+---+---+---+---+---+---+---+</span><br><span class="line">| 1 |        Index (7+)         |</span><br><span class="line">+---+---------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="增加动态表"><a href="#增加动态表" class="headerlink" title="增加动态表"></a>增加动态表</h3><p>当已有的HPACK表中没有索引时，需要增加动态表。此时对应的是 <strong>e.dynTab.add(f)</strong> 该方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dt *dynamicTable)</span> <span class="title">add</span><span class="params">(f HeaderField)</span></span> &#123;</span><br><span class="line">	dt.table.addEntry(f)</span><br><span class="line">	dt.size += f.Size()</span><br><span class="line">	dt.evict()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态表新增非常简单，就是简单的 <span style="color:#FF7F50">addEntry</span> 方法，其本质是静态 <span style="color:#FF7F50">Huffman</span> 编码，但实际上的编码过程在后面的两个函数 <strong>appendNewName(e.buf, f, indexing)</strong> 和 <strong>appendIndexedName(e.buf, f, idx, indexing)</strong><br>这两个函数分别表示 一、Header 的 Name 和 Value 均无匹配索引; 二、Header 的 Name 有匹配索引<br>这两种情况均会将 Header 添加到动态表中。</p>
<p>先看 <strong>appendNewName(e.buf, f, indexing)</strong> 这个函数。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendNewName</span><span class="params">(dst []<span class="keyword">byte</span>, f HeaderField, indexing <span class="keyword">bool</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	dst = <span class="built_in">append</span>(dst, encodeTypeByte(indexing, f.Sensitive)) <span class="comment">// 返回0x40 </span></span><br><span class="line">    dst = appendHpackString(dst, f.Name)</span><br><span class="line">	<span class="keyword">return</span> appendHpackString(dst, f.Value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过编码后会呈下图所示：可参考 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7541#section-6.2.1" style="color:#556B2F"> rfc7541#section-6.2.1</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  0   1   2   3   4   5   6   7</span><br><span class="line">+---+---+---+---+---+---+---+---+</span><br><span class="line">| 0 | 1 |           0           |</span><br><span class="line">+---+---+-----------------------+</span><br><span class="line">| H |     Name Length (7+)      |</span><br><span class="line">+---+---------------------------+</span><br><span class="line">|  Name String (Length octets)  |</span><br><span class="line">+---+---------------------------+</span><br><span class="line">| H |     Value Length (7+)     |</span><br><span class="line">+---+---------------------------+</span><br><span class="line">| Value String (Length octets)  |</span><br><span class="line">+-------------------------------+</span><br></pre></td></tr></table></figure></p>
<p>另一个 <strong>appendIndexedName(e.buf, f, idx, indexing)</strong> 方法<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendIndexedName</span><span class="params">(dst []<span class="keyword">byte</span>, f HeaderField, i <span class="keyword">uint64</span>, indexing <span class="keyword">bool</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	first := <span class="built_in">len</span>(dst)</span><br><span class="line">	<span class="keyword">var</span> n <span class="keyword">byte</span></span><br><span class="line">	<span class="keyword">if</span> indexing &#123;   <span class="comment">// 是否应该被索引		</span></span><br><span class="line">        n = <span class="number">6</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		n = <span class="number">4</span></span><br><span class="line">	&#125;</span><br><span class="line">	dst = appendVarInt(dst, n, i)</span><br><span class="line">	dst[first] |= encodeTypeByte(indexing, f.Sensitive)</span><br><span class="line">	<span class="keyword">return</span> appendHpackString(dst, f.Value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>经过编码后会呈下图所示：可参考 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc7541#section-6.2.1" style="color:#556B2F"> rfc7541#section-6.2.1</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  0   1   2   3   4   5   6   7</span><br><span class="line">+---+---+---+---+---+---+---+---+</span><br><span class="line">| 0 | 1 |      Index (6+)       |</span><br><span class="line">+---+---+-----------------------+</span><br><span class="line">| H |     Value Length (7+)     |</span><br><span class="line">+---+---------------------------+</span><br><span class="line">| Value String (Length octets)  |</span><br><span class="line">+-------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="Huffman-编码原理"><a href="#Huffman-编码原理" class="headerlink" title="Huffman 编码原理"></a>Huffman 编码原理</h3><p><span style="color:#FF7F50"> Hpack</span> 中的 <span style="color:#FF7F50">Huffman</span> 是静态<span style="color:#FF7F50">Huffman</span>编码，对应上面的 <strong>appendHpackString</strong> 函数，接下来我们详细看看。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendHpackString</span><span class="params">(dst []<span class="keyword">byte</span>, s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	huffmanLength := HuffmanEncodeLength(s)</span><br><span class="line">	<span class="keyword">if</span> huffmanLength &lt; <span class="keyword">uint64</span>(<span class="built_in">len</span>(s)) &#123;</span><br><span class="line">		first := <span class="built_in">len</span>(dst)</span><br><span class="line">		dst = appendVarInt(dst, <span class="number">7</span>, huffmanLength)</span><br><span class="line">		dst = AppendHuffmanString(dst, s)</span><br><span class="line">		dst[first] |= <span class="number">0x80</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dst = appendVarInt(dst, <span class="number">7</span>, <span class="keyword">uint64</span>(<span class="built_in">len</span>(s)))</span><br><span class="line">		dst = <span class="built_in">append</span>(dst, s...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dst</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法有一个 <span style="color:#FF7F50">if-else</span> ，是为了判断是否要 <span style="color:#FF7F50">Huffman</span> 编码 ，如果编码后长度反而变大了，那还不如不编码用原始字符。</p>
<p><span style="color:#FF7F50"> Huffman </span> 编码原理如下，就是对静态 <span style="color:#FF7F50"> Huffman </span> 表进行查询，将传输中的字符串编码。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendByteToHuffmanCode</span><span class="params">(dst []<span class="keyword">byte</span>, rembits <span class="keyword">uint8</span>, c <span class="keyword">byte</span>)</span> <span class="params">([]<span class="keyword">byte</span>, <span class="keyword">uint8</span>)</span></span> &#123;</span><br><span class="line">	code := huffmanCodes[c]</span><br><span class="line">	nbits := huffmanCodeLen[c]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> rembits &gt; nbits &#123;</span><br><span class="line">			t := <span class="keyword">uint8</span>(code &lt;&lt; (rembits - nbits))</span><br><span class="line">			dst[<span class="built_in">len</span>(dst)<span class="number">-1</span>] |= t</span><br><span class="line">			rembits -= nbits</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		t := <span class="keyword">uint8</span>(code &gt;&gt; (nbits - rembits))</span><br><span class="line">		dst[<span class="built_in">len</span>(dst)<span class="number">-1</span>] |= t</span><br><span class="line"></span><br><span class="line">		nbits -= rembits</span><br><span class="line">		rembits = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> nbits == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		dst = <span class="built_in">append</span>(dst, <span class="number">0</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dst, rembits</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> huffmanCodes = [<span class="number">256</span>]<span class="keyword">uint32</span>&#123;</span><br><span class="line">	<span class="number">0x1ff8</span>,</span><br><span class="line">	<span class="number">0x7fffd8</span>,</span><br><span class="line">	<span class="number">0xfffffe2</span>,</span><br><span class="line">	<span class="number">0xfffffe3</span>,</span><br><span class="line">	<span class="number">0xfffffe4</span>,</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> huffmanCodeLen = [<span class="number">256</span>]<span class="keyword">uint8</span>&#123;</span><br><span class="line">	<span class="number">13</span>, <span class="number">23</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">24</span>, <span class="number">30</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">30</span>, <span class="number">28</span>, <span class="number">28</span>,</span><br><span class="line">	<span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">30</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>, <span class="number">28</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h1 id="验证-amp-总结"><a href="#验证-amp-总结" class="headerlink" title="验证&amp;总结"></a>验证&amp;总结</h1><h2 id="HPACK-编码"><a href="#HPACK-编码" class="headerlink" title="HPACK 编码"></a>HPACK 编码</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  buf     bytes.Buffer</span><br><span class="line">  oriSize <span class="keyword">int</span></span><br><span class="line">)</span><br><span class="line">henc := hpack.NewEncoder(&amp;buf)</span><br><span class="line">headers := []hpack.HeaderField&#123;</span><br><span class="line">  &#123;Name: <span class="string">&quot;:authority&quot;</span>, Value: <span class="string">&quot;dss0.bdstatic.com&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;:method&quot;</span>, Value: <span class="string">&quot;GET&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;:path&quot;</span>, Value: <span class="string">&quot;/5aV1bjqh_Q23odCf/static/superman/img/topnav/baiduyun@2x-e0be79e69e.png&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;:scheme&quot;</span>, Value: <span class="string">&quot;https&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;accept-encoding&quot;</span>, Value: <span class="string">&quot;gzip&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;user-agent&quot;</span>, Value: <span class="string">&quot;Go-http-client/2.0&quot;</span>&#125;,</span><br><span class="line">  &#123;Name: <span class="string">&quot;custom-header&quot;</span>, Value: <span class="string">&quot;custom-value&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, header := <span class="keyword">range</span> headers &#123;</span><br><span class="line">  oriSize += <span class="built_in">len</span>(header.Name) + <span class="built_in">len</span>(header.Value)</span><br><span class="line">  henc.WriteField(header)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;ori size: %v, encoded size: %v\n&quot;</span>, oriSize, buf.Len())</span><br><span class="line"><span class="comment">//输出为：ori size: 197, encoded size: 111</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="HPACK-解码"><a href="#HPACK-解码" class="headerlink" title="HPACK 解码"></a>HPACK 解码</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此处省略HPACK编码中的编码例子</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">  invalid    error</span><br><span class="line">  sawRegular <span class="keyword">bool</span></span><br><span class="line">  <span class="comment">// 16 &lt;&lt; 20 from fr.maxHeaderListSize() from</span></span><br><span class="line">  remainSize <span class="keyword">uint32</span> = <span class="number">16</span> &lt;&lt; <span class="number">20</span></span><br><span class="line">)</span><br><span class="line">hdec := hpack.NewDecoder(<span class="number">4096</span>, <span class="literal">nil</span>)</span><br><span class="line"><span class="comment">// 16 &lt;&lt; 20 from fr.maxHeaderStringLen() from fr.maxHeaderListSize()</span></span><br><span class="line">hdec.SetMaxStringLength(<span class="keyword">int</span>(remainSize))</span><br><span class="line">hdec.SetEmitFunc(<span class="function"><span class="keyword">func</span><span class="params">(hf hpack.HeaderField)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> !httpguts.ValidHeaderFieldValue(hf.Value) &#123;</span><br><span class="line">    invalid = fmt.Errorf(<span class="string">&quot;invalid header field value %q&quot;</span>, hf.Value)</span><br><span class="line">  &#125;</span><br><span class="line">  isPseudo := strings.HasPrefix(hf.Name, <span class="string">&quot;:&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> isPseudo &#123;</span><br><span class="line">    <span class="keyword">if</span> sawRegular &#123;</span><br><span class="line">      invalid = errors.New(<span class="string">&quot;pseudo header field after regular&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sawRegular = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// if !http2validWireHeaderFieldName(hf.Name) &#123;</span></span><br><span class="line">    <span class="comment">// 	invliad = fmt.Sprintf(&quot;invalid header field name %q&quot;, hf.Name)</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> invalid != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(invalid)</span><br><span class="line">    hdec.SetEmitEnabled(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  size := hf.Size()</span><br><span class="line">  <span class="keyword">if</span> size &gt; remainSize &#123;</span><br><span class="line">    hdec.SetEmitEnabled(<span class="literal">false</span>)</span><br><span class="line">    <span class="comment">// mh.Truncated = true</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  remainSize -= size</span><br><span class="line">  fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, hf)</span><br><span class="line">  <span class="comment">// mh.Fields = append(mh.Fields, hf)</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">defer</span> hdec.SetEmitFunc(<span class="function"><span class="keyword">func</span><span class="params">(hf hpack.HeaderField)</span></span> &#123;&#125;)</span><br><span class="line">fmt.Println(hdec.Write(buf.Bytes()))</span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line"><span class="comment">// ori size: 197, encoded size: 111</span></span><br><span class="line"><span class="comment">// header field &quot;:authority&quot; = &quot;dss0.bdstatic.com&quot;</span></span><br><span class="line"><span class="comment">// header field &quot;:method&quot; = &quot;GET&quot;</span></span><br><span class="line"><span class="comment">// header field &quot;:path&quot; = &quot;/5aV1bjqh_Q23odCf/static/superman/img/topnav/baiduyun@2x-e0be79e69e.png&quot;</span></span><br><span class="line"><span class="comment">// header field &quot;:scheme&quot; = &quot;https&quot;</span></span><br><span class="line"><span class="comment">// header field &quot;accept-encoding&quot; = &quot;gzip&quot;</span></span><br><span class="line"><span class="comment">// header field &quot;user-agent&quot; = &quot;Go-http-client/2.0&quot;</span></span><br><span class="line"><span class="comment">// header field &quot;custom-header&quot; = &quot;custom-value&quot;</span></span><br><span class="line"><span class="comment">// 111 &lt;nil&gt;</span></span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">kiosk</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://kiosk007.top/2022/02/26/HTTP-2-0-Header-Compression/">http://kiosk007.top/2022/02/26/HTTP-2-0-Header-Compression/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/network/">network</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=kiosk" async></script><nav id="pagination"><div class="next-post pull-right"><a href="/2022/02/05/%E6%93%8D%E7%BA%B5%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E6%B1%87%E6%80%BB/"><span>操纵系统知识汇总</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = 'false' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'XhYn8GEq1Sg7ufJQAVmR4dWN-gzGzoHsz',
  appKey:'r42k4lqU022wD7IvtwGaQfjN',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://img1.kiosk007.top/static/images/backgroud_sbpk.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2022 By kiosk</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">京ICP备20015006号-1</a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="https://img1.kiosk007.top/static/js/utils.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/fancybox.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/sidebar.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/copy.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/fireworks.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/transition.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/scroll.js?version=1.9.0"></script><script src="https://img1.kiosk007.top/static/js/head.js?version=1.9.0"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="https://img1.kiosk007.top/static/js/katex.js"></script><script src="https://img1.kiosk007.top/static/js/search/local-search.js"></script><script id="ribbon" src="https://img1.kiosk007.top/static/js/third-party/canvas-ribbon.js" size="150" alpha="0.3" zIndex="-1" data-click="true"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>